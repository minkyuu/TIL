# 2021.08.12. TIL (Interrupt)

### 인터럽트란 ?

> CPU가 프로그램을 실행하고 있을 때, “입출력 하드웨어 등의 장치” or “예외상황이 발생” 하여 중간에 처리가 필요할 경우에 CPU에 알려서 해당 이벤트를 처리하는 기술

---

### Q. 인터럽트가 필요한 이유는?
1. 선점형 스케줄러 구현
  
    : 프로세스 running 중에 스케줄러가 이를 중단시키고, 다른 프로세스로 교체하기 위해, 현재 프로세스 실행을 중단시킴

2. IO Device와의 커뮤니케이션

    : 저장 매체에서 데이터 처리 완료 시, 프로세스를 깨워야 한다. (block state  ready state)

3. 예외 상황 핸들링

---

### 인터럽트 처리 예 (CPU가 프로그램을 실행하고 있을 때)
1. 입출력 하드웨어 등의 장치 이슈 발생
    - 파일 처리가 끝났다는 것을 OS에 알리기
   - OS는 해당 프로세스를 block state에서 ready 상태로 프로세스 상태 변경을 한다.

2. 예외 상황 발생
    - 0으로 나누는 계산이 발생해서, 예외 상황을 OS에 알려주기
    - OS가 해당 프로세스 실행 중지/에러 표시

---

### 이벤트와 인터럽트

    : 인터럽트는 일종의 이벤트로 불린다.
  
    : 이벤트에 맞게 OS가 처리

### 주요 인터럽트

1. 계산하는 코드에서 0으로 나누느 코드 실행 시

2. 타이머 인터럽트

3. IO 인터럽트

---

### 인터럽트 종류
1. 내부 인터럽트
    : 주로 프로그램 내부에서 잘못된 명령 또는 잘못된 데이터 사용 시 발생
    : 소프트웨어 인터럽트라고도 한다.
      - 0으로 나눌 때
      - 사용자 모드에서 허용되지 않은 명령 또는 공간 접근 시
      - 계산 결과가 Overflow / Underflow 발생 시

2. 외부 인터럽트
    : 주로 HW에서 발생되는 이벤트 (프로그램 외부)
    : 하드웨어 인터럽트라고도 한다.
      - 전원 이상
      - 기계 문제
      - 키보드 등 IO 관련 이벤트
      - Timer 이벤트

---

### 시스템 콜 인터럽트

    : 시스템 콜 실행을 위해서는 강제로 코드에 인터럽트 명령을 넣어 CPU에게 실행시켜야 한다.

### 시스템 콜 인터럽트 로직
1. eax 레지스터에 시스템 콜 번호를 넣고
2. ebx 레지스터에는 시스템 콜에 해당하는 인자값을 넣고
3. 소프트웨어 인터럽트 명령을 호출하면서 0x80값을 넘겨준다.
3.1. CPU는 사용자 모드를 커널 모드로 바꿔줌
3.2. IDT(Interrupt Descripter Table)에서 0x80에 해당하는 주소(함수)를 찾아서 실행함
3.3. system_call( ) 함수에서 eax로부터 시스템 콜 번호를 찾아서 해당 번호에 맞는 시스템 콜 함수로 이동한다.
3.4. 해당 시스템 콜 함수 실행 후, 다시 커널 모드에서 사용자 모드로 변경하고, 다시 해당 프로세스 다음 코드 진행

-> 잘 보면 사용자 모드와 커널 모드를 계속 오고 가면서 진행된다.

---

### 인터럽트와 IDT
   
   : 인터럽트는 미리 정의되어 각각 번호와 실행 코드를 가리키는 주소가 기록되어 있음
   
      - Where? -> IDT(Interrupt Descripter Table)에 기록
      - When?  -> 컴퓨터 부팅 시 OS가 기록
      - What code? -> OS 내부 코드

---

간단하게 정리를 해보자면
1. 인터럽트가 발생 시 , IDT를 확인
2. 시스템 콜 인터럽트 명령은 0x80 번호에 미리 정의
3. 인터럽트 0x80에 해당하는 OS 코드는 system_call( ) 이라는 함수
4. 즉, IDT에는 0x80  system_call( ) 와 같은 정보가 기록되어 있음


리눅스 같은 경우에는 다음과 같다.
- 0 ~ 31 : 예외 상황 인터럽트 (일부는 정의 안된 채로 남겨져 있음)
- 32 ~ 47 : 하드웨어 인터럽트 (주변장치 종류/개수에 따라 변경 가능)
- 128 : 시스템 콜

---

### 인터럽트와 프로세스의 관계
1. 프로세스 실행 중 인터럽트 발생
2. 현 프로세스 실행 중단
3. 인터럽트 번호에 해당하는 인터럽트 처리 함수 실행 (OS)
4. 현 프로세스 재실행

### 인터럽트와 선점형 스케줄러의 관계

   : 수시로 타이머 인터럽트가 발생
   
      - OS가 타이머 인터럽트 발생 횟수를 기억해서 5번 타이머 인터럽트가 발생하면, 현재 프로세스를 다른 프로세스로 바꿔준다.
